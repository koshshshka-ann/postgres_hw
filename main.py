"""
–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥—Ä–∞–π–≤–µ—Ä–∞ PostgreSQL –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏
"""

from postgres_driver import PostgresDriver


def demonstrate_crud_operations():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π"""

    print("=" * 50)
    print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ê–ë–û–¢–´ –° POSTGRESQL –ß–ï–†–ï–ó –î–†–ê–ô–í–ï–†")
    print("=" * 50)

    # –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    print("\n1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞:")
    print("-" * 40)

    with PostgresDriver() as db:
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
        if db.create_tables():
            print("‚úÖ –¢–∞–±–ª–∏—Ü—ã users –∏ orders —Å–æ–∑–¥–∞–Ω—ã")

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        users_data = [
            ("–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞", 25),
            ("–ò–≤–∞–Ω –°–∏–¥–æ—Ä–æ–≤", 30),
            ("–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞", 28),
            ("–ê–ª–µ–∫—Å–µ–π –ö–æ–∑–ª–æ–≤", 35)
        ]

        user_ids = []
        for name, age in users_data:
            user_id = db.add_user(name, age)
            if user_id:
                user_ids.append(user_id)
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {name} (ID: {user_id}, –≤–æ–∑—Ä–∞—Å—Ç: {age})")

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑—ã
        orders_data = [
            (user_ids[0], 1250.50),  # –ê–Ω–Ω–∞
            (user_ids[0], 499.90),  # –ê–Ω–Ω–∞
            (user_ids[1], 750.00),  # –ò–≤–∞–Ω
            (user_ids[1], 1200.00),  # –ò–≤–∞–Ω
            (user_ids[1], 300.50),  # –ò–≤–∞–Ω
            (user_ids[2], 1500.00),  # –ú–∞—Ä–∏—è
            # –£ –ê–ª–µ–∫—Å–µ—è –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤
        ]

        for user_id, amount in orders_data:
            order_id = db.add_order(user_id, amount)
            if order_id:
                print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∑–∞–∫–∞–∑: ID {order_id}, —Å—É–º–º–∞ {amount:.2f} —Ä—É–±.")

        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        print("\n2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:")
        print("-" * 40)

        totals = db.get_user_totals()
        for name, total in totals:
            print(f"   {name}: {total:>10.2f} —Ä—É–±.")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        print("\n3. –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:")
        print("-" * 40)

        for user_id, name, age in db.get_all_users():
            orders = db.get_user_orders(user_id)
            order_count = len(orders)
            print(f"\n   üë§ {name} (–≤–æ–∑—Ä–∞—Å—Ç: {age})")
            print(f"   üìä –ó–∞–∫–∞–∑–æ–≤: {order_count}")

            if orders:
                total = sum(order[1] for order in orders)
                print(f"   üí∞ –û–±—â–∞—è —Å—É–º–º–∞: {total:.2f} —Ä—É–±.")
                print(f"   üìù –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤:")
                for order_id, amount, created_at in orders:
                    print(f"      ‚Ä¢ –ó–∞–∫–∞–∑ #{order_id}: {amount:.2f} —Ä—É–±. ({created_at.strftime('%d.%m.%Y %H:%M')})")
            else:
                print(f"   üí∞ –û–±—â–∞—è —Å—É–º–º–∞: 0.00 —Ä—É–±.")
                print(f"   üìù –ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç")

        # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
        print("\n4. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è:")
        print("-" * 40)

        # –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∂–µ–º —Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        test_user_id = user_ids[1]  # –ò–≤–∞–Ω (—É –Ω–µ–≥–æ 3 –∑–∞–∫–∞–∑–∞)
        orders_before = db.get_user_orders(test_user_id)
        print(f"   –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {test_user_id} —Å–µ–π—á–∞—Å {len(orders_before)} –∑–∞–∫–∞–∑–æ–≤")

        # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if db.delete_user(test_user_id):
            print(f"   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID {test_user_id} —É–¥–∞–ª–µ–Ω")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–∫–∞–∑—ã —Ç–æ–∂–µ —É–¥–∞–ª–∏–ª–∏—Å—å
            print(f"   –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞–∫–∞–∑—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω—ã –±–ª–∞–≥–æ–¥–∞—Ä—è ON DELETE CASCADE")

        # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print("\n5. –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print("-" * 40)

        final_totals = db.get_user_totals()
        for name, total in final_totals:
            print(f"   {name}: {total:>10.2f} —Ä—É–±.")

    print("\n" + "=" * 50)
    print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
    print("=" * 50)


def demonstrate_error_handling():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""

    print("\n\n" + "=" * 50)
    print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö")
    print("=" * 50)

    db = PostgresDriver()

    # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    print("\n1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º:")
    print("-" * 40)

    # –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –Ω–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π
    import os
    original_password = os.getenv("DB_PASSWORD")
    os.environ["DB_PASSWORD"] = "wrong_password"

    if not db.connect():
        print("   ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")

    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
    os.environ["DB_PASSWORD"] = original_password

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º
    if db.connect():
        print("\n2. –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:")
        print("-" * 40)

        # –í–æ–∑—Ä–∞—Å—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (–Ω–∞—Ä—É—à–µ–Ω–∏–µ CHECK constraint)
        user_id = db.add_user("–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", -5)
        if user_id is None:
            print("   ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ—à–∏–±–∫–∞ CHECK constraint (–≤–æ–∑—Ä–∞—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)")

        # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id –¥–ª—è –∑–∞–∫–∞–∑–∞
        order_id = db.add_order(99999, 100.00)  # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π user_id
        if order_id is None:
            print("   ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –æ—à–∏–±–∫–∞ foreign key constraint")

        db.disconnect()


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""

    print("\nüöÄ –ó–ê–ü–£–°–ö –ü–†–û–ì–†–ê–ú–ú–´ –†–ê–ë–û–¢–´ –° POSTGRESQL")

    try:
        # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        demonstrate_crud_operations()

        # –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
        demonstrate_error_handling()

        print("\n‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")

    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        return 1

    return 0


if __name__ == "__main__":
    exit(main())
