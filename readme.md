# PostgreSQL + Python: Средний трек с драйвером

## Описание
Проект демонстрирует работу с PostgreSQL через Python-драйвер с поддержкой CRUD операций, связей между таблицами и агрегации данных.

## Функциональность
- Подключение к PostgreSQL через psycopg2
- Создание связанных таблиц users и orders
- CRUD операции для пользователей и заказов
- Агрегация данных (JOIN + SUM + GROUP BY)
- Обработка ошибок и транзакции
- Контекстный менеджер для автоматического управления соединением

## Установка

### 1. Настройка базы данных
```sql
-- Создайте базу данных test если еще не создана
-- Таблицы создадутся автоматически при запуске программы
```

### 2. Установка зависимостей
```bash
# Создайте виртуальное окружение
python -m venv venv

# Активируйте его
# Windows:
venv\Scripts\activate
# Mac/Linux:
source venv/bin/activate

# Установите зависимости
pip install -r requirements.txt
```

### 3. Настройка подключения
```bash
# Скопируйте содержимое из .env.example

DB_HOST=localhost
DB_PORT=5432
DB_NAME=test
DB_USER=postgres
DB_PASSWORD=ваш_пароль_от_postgres

# Отредактируйте .env, указав ваши данные подключения
```

## Использование

### Запуск демонстрации
```bash
python main.py
```

### Использование драйвера в своем коде
```python
from postgres_driver import PostgresDriver

# Способ 1: С контекстным менеджером (рекомендуется)
with PostgresDriver() as db:
    db.create_tables()
    user_id = db.add_user("Иван", 30)
    order_id = db.add_order(user_id, 500.50)
    totals = db.get_user_totals()

# Способ 2: Вручную
db = PostgresDriver()
db.connect()
try:
    # работа с базой
    db.create_tables()
finally:
    db.disconnect()
```

## Структура базы данных

### Таблица users
```sql
CREATE TABLE users (
    id   SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    age  INTEGER CHECK (age >= 0)
);
```

### Таблица orders
```sql
CREATE TABLE orders (
    id         SERIAL PRIMARY KEY,
    user_id    INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    amount     NUMERIC(10,2) NOT NULL CHECK (amount >= 0),
    created_at TIMESTAMP DEFAULT NOW()
);
```

## Особенности реализации
1. **Безопасность**: Использование параметризованных запросов для предотвращения SQL-инъекций
2. **Транзакции**: Автоматический rollback при ошибках
3. **Типизация**: Аннотации типов для лучшей читаемости кода
4. **Обработка ошибок**: Корректная обработка исключений psycopg2
5. **Контекстный менеджер**: Автоматическое управление соединением

## Пример вывода программы
```
==================================================
ДЕМОНСТРАЦИЯ РАБОТЫ С POSTGRESQL ЧЕРЕЗ ДРАЙВЕР
==================================================

1. Использование контекстного менеджера:
----------------------------------------
✅ Таблицы users и orders созданы
✅ Добавлен пользователь: Анна Петрова (ID: 1, возраст: 25)
✅ Добавлен пользователь: Иван Сидоров (ID: 2, возраст: 30)
...

2. Статистика заказов по пользователям:
----------------------------------------
   Иван Сидоров:    2250.50 руб.
   Анна Петрова:    1750.40 руб.
   Мария Иванова:   1500.00 руб.
   Алексей Козлов:     0.00 руб.
```

## Требования
- Python 3.8+
- PostgreSQL 12+
- pgAdmin 4 (для визуального управления)

## Лицензия
MIT
